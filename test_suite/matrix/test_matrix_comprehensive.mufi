// Comprehensive Matrix Test - RREF, Literals, and Indexing
// Tests all three new matrix features working together

print "=== COMPREHENSIVE MATRIX FEATURES TEST ===";

fun test_matrix_literals_with_indexing() {
    print "\n[Test 1] Matrix literals with indexing";

    // Create matrix using literal syntax
    var A = [[1, 2, 3], [4, 5, 6], [7, 8, 9]];

    // Test individual element access
    assert(A[1,1], 1.0);
    assert(A[1,2], 2.0);
    assert(A[2,2], 5.0);
    assert(A[3,3], 9.0);

    // Modify elements using indexing
    A[1,1] = 10;
    A[2,2] = 50;
    A[3,3] = 90;

    // Verify modifications
    assert(A[1,1], 10.0);
    assert(A[2,2], 50.0);
    assert(A[3,3], 90.0);

    // Test trace after modifications
    var expected_trace = 10.0 + 50.0 + 90.0;
    assert(trace(A), expected_trace);

    print "âœ“ Matrix literals with indexing passed";
}

fun test_rref_with_literals() {
    print "\n[Test 2] RREF with matrix literals";

    // Test RREF on a simple matrix
    var B = [[2, 4], [1, 2]];
    var B_rref = rref(B);

    // This should reduce to [[1, 2], [0, 0]] since second row is linearly dependent
    assert(rank(B), 1);
    assert(B_rref[1,1], 1.0);  // First element should be 1
    assert(B_rref[1,2], 2.0);  // Second element should be 2
    assert(B_rref[2,1], 0.0);  // Third element should be 0
    assert(B_rref[2,2], 0.0);  // Fourth element should be 0

    // Test RREF on identity matrix
    var I = [[1, 0, 0], [0, 1, 0], [0, 0, 1]];
    var I_rref = rref(I);
    assert(rank(I), 3);
    assert(det(I_rref), 1.0);
    assert(trace(I_rref), 3.0);

    // Test RREF on a more complex matrix
    var C = [[1, 2, 1], [2, 4, 3], [3, 6, 4]];
    var C_rref = rref(C);
    var C_rank = rank(C);

    // This matrix should have rank 2
    assert(C_rank, 2);

    print "âœ“ RREF with literals passed";
}

fun test_indexing_with_rref() {
    print "\n[Test 3] Indexing with RREF results";

    // Create a matrix and compute its RREF
    var A = [[3, 6, 9], [1, 2, 3], [2, 4, 6]];
    var A_rref = rref(A);

    // The RREF should have rank 1 (all rows are multiples of each other)
    assert(rank(A), 1);

    // First row should be [1, 2, 3] after reduction
    assert(A_rref[1,1], 1.0);
    assert(A_rref[1,2], 2.0);
    assert(A_rref[1,3], 3.0);

    // Other rows should be zero
    assert(A_rref[2,1], 0.0);
    assert(A_rref[2,2], 0.0);
    assert(A_rref[2,3], 0.0);
    assert(A_rref[3,1], 0.0);
    assert(A_rref[3,2], 0.0);
    assert(A_rref[3,3], 0.0);

    print "âœ“ Indexing with RREF passed";
}

fun test_solving_linear_system() {
    print "\n[Test 4] Solving linear system using RREF";

    // Create augmented matrix for system:
    // x + 2y = 5
    // 2x + 3y = 8
    var augmented = [[1, 2, 5], [2, 3, 8]];
    var solution = rref(augmented);

    // The RREF should give us the solution
    // Expected RREF: [[1, 0, 1], [0, 1, 2]] meaning x=1, y=2
    assert(solution[1,1], 1.0);  // x coefficient
    assert(solution[1,2], 0.0);  // y coefficient for x equation
    assert(solution[1,3], 1.0);  // x value

    assert(solution[2,1], 0.0);  // x coefficient for y equation
    assert(solution[2,2], 1.0);  // y coefficient
    assert(solution[2,3], 2.0);  // y value

    // Verify the solution by substitution
    var x = solution[1,3];
    var y = solution[2,3];
    var check1 = x + 2 * y;  // Should equal 5
    var check2 = 2 * x + 3 * y;  // Should equal 8

    assert(check1, 5.0);
    assert(check2, 8.0);

    print "âœ“ Linear system solving passed";
}

fun test_matrix_rank_analysis() {
    print "\n[Test 5] Matrix rank analysis";

    // Test various rank matrices
    var rank0 = [[0, 0], [0, 0]];
    assert(rank(rank0), 0);

    var rank1 = [[1, 2], [2, 4]];
    assert(rank(rank1), 1);

    var rank2 = [[1, 2], [3, 4]];
    assert(rank(rank2), 2);

    // Test rank with RREF
    var test_matrix = [[1, 2, 3], [4, 5, 6], [7, 8, 9]];
    var test_rank = rank(test_matrix);
    var test_rref = rref(test_matrix);

    // Verify that RREF preserves rank
    assert(rank(test_rref), test_rank);

    // This specific matrix should have rank 2
    assert(test_rank, 2);

    print "âœ“ Matrix rank analysis passed";
}

fun test_interactive_matrix_construction() {
    print "\n[Test 6] Interactive matrix construction";

    // Build a matrix element by element
    var M = zeros(3, 3);

    // Set diagonal elements
    M[1,1] = 1;
    M[2,2] = 2;
    M[3,3] = 3;

    // Set off-diagonal elements
    M[1,2] = 4;
    M[2,1] = 5;
    M[1,3] = 6;
    M[3,1] = 7;
    M[2,3] = 8;
    M[3,2] = 9;

    // Verify the construction
    assert(M[1,1], 1.0);
    assert(M[2,2], 2.0);
    assert(M[3,3], 3.0);
    assert(M[1,2], 4.0);
    assert(M[2,1], 5.0);

    // Test trace and determinant
    var M_trace = trace(M);
    var expected_trace = 1.0 + 2.0 + 3.0;
    assert(M_trace, expected_trace);

    // Test rank
    var M_rank = rank(M);
    assert(M_rank, 3);  // Should be full rank

    print "âœ“ Interactive matrix construction passed";
}

fun test_matrix_equation_solving() {
    print "\n[Test 7] Matrix equation solving with RREF";

    // Solve Ax = b using RREF on [A|b]
    // System: 2x + y = 7, x - y = 1
    var system = [[2, 1, 7], [1, -1, 1]];
    var solved = rref(system);

    // Extract solution
    var x_sol = solved[1,3];
    var y_sol = solved[2,3];

    // Verify solution
    var eq1_check = 2 * x_sol + y_sol;
    var eq2_check = x_sol - y_sol;

    assert(eq1_check > 6.99 and eq1_check < 7.01, true);  // Should be 7
    assert(eq2_check > 0.99 and eq2_check < 1.01, true);  // Should be 1

    print "âœ“ Matrix equation solving passed";
}

fun test_combined_operations() {
    print "\n[Test 8] Combined matrix operations";

    // Create matrices using literals
    var A = [[1, 2], [3, 4]];
    var B = [[5, 6], [7, 8]];

    // Combine using arithmetic
    var C = A + B;

    // Expected: C = [[6, 8], [10, 12]]
    assert(C[1,1], 6.0);
    assert(C[1,2], 8.0);
    assert(C[2,1], 10.0);
    assert(C[2,2], 12.0);

    // Test RREF on the result
    var C_rref = rref(C);
    var C_rank = rank(C);

    // C should have rank 2 (non-singular)
    assert(C_rank, 2);

    // Modify an element and recompute
    C[1,1] = 0;
    C[2,1] = 0;  // Make first column zero

    var C_modified_rank = rank(C);
    assert(C_modified_rank, 1);  // Should reduce rank to 1

    print "âœ“ Combined operations passed";
}

fun test_matrix_properties_with_indexing() {
    print "\n[Test 9] Matrix properties with indexing";

    // Create a symmetric matrix using indexing
    var S = zeros(3, 3);

    // Set symmetric elements
    S[1,1] = 1; S[1,2] = 2; S[1,3] = 3;
    S[2,1] = 2; S[2,2] = 4; S[2,3] = 5;
    S[3,1] = 3; S[3,2] = 5; S[3,3] = 6;

    // Verify symmetry
    assert(S[1,2], S[2,1]);
    assert(S[1,3], S[3,1]);
    assert(S[2,3], S[3,2]);

    // Test transpose (should equal original for symmetric)
    var S_t = transpose(S);
    assert(S_t[1,2], S[1,2]);
    assert(S_t[2,1], S[2,1]);

    // Test determinant and trace
    var S_det = det(S);
    var S_trace = trace(S);
    var expected_trace = 1.0 + 4.0 + 6.0;
    assert(S_trace, expected_trace);

    print "âœ“ Matrix properties with indexing passed";
}

fun test_error_handling() {
    print "\n[Test 10] Error handling integration";

    // Test that operations still work correctly after potential issues
    var valid = [[1, 2], [3, 4]];

    // Test normal operations
    assert(det(valid) != 0.0, true);  // Should be non-singular
    assert(rank(valid), 2);

    // Test indexing bounds (within valid range)
    var elem = valid[1,1];
    assert(elem, 1.0);

    // Test RREF on valid matrix
    var valid_rref = rref(valid);
    assert(rank(valid_rref), 2);

    // Test that system continues working
    var another = [[2, 3], [4, 5]];
    var sum = valid + another;
    assert(sum[1,1], 3.0);  // 1 + 2 = 3

    print "âœ“ Error handling integration passed";
}

// Run all comprehensive tests
test_matrix_literals_with_indexing();
test_rref_with_literals();
test_indexing_with_rref();
test_solving_linear_system();
test_matrix_rank_analysis();
test_interactive_matrix_construction();
test_matrix_equation_solving();
test_combined_operations();
test_matrix_properties_with_indexing();
test_error_handling();

print "\n=== ALL COMPREHENSIVE MATRIX TESTS PASSED ===";
print "ðŸŽ‰ COMPLETE MATRIX IMPLEMENTATION VERIFIED ðŸŽ‰";
print "";
print "Features successfully tested:";
print "âœ“ Matrix literals with [[]] syntax";
print "âœ“ Matrix indexing with A[i,j] syntax";
print "âœ“ RREF (Reduced Row Echelon Form)";
print "âœ“ Matrix rank computation";
print "âœ“ Linear system solving";
print "âœ“ Integration with existing matrix operations";
print "";
print "MufiZ now has full Octave-compatible matrix support!";
